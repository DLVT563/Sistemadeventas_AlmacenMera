@model Sistemadeventas_AlmacenMera.Models.Producto

@{ 
    ViewData["Title"] = "Editar Producto";
}

@{
    var fotoActual = string.IsNullOrEmpty(Model.FotoPath) ? string.Empty : Url.Content($"~/{Model.FotoPath}");
    var clasePreview = string.IsNullOrEmpty(fotoActual) ? "d-none" : string.Empty;
    var clasePlaceholder = string.IsNullOrEmpty(fotoActual) ? string.Empty : "d-none";
}

<div class="container mt-4">
    <h2 class="fw-bold text-primary mb-3">Editar Producto</h2>
    <hr />

    <div class="row justify-content-center">
        <div class="col-lg-7 col-xl-6">
            <form asp-action="Edit" class="card shadow-sm p-4" enctype="multipart/form-data">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                <input type="hidden" asp-for="IdProducto" />

                <div class="mb-3">
                    <label asp-for="NombreProducto" class="form-label"></label>
                    <input asp-for="NombreProducto" class="form-control" />
                    <span asp-validation-for="NombreProducto" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Descripcion" class="form-label"></label>
                    <textarea asp-for="Descripcion" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="Descripcion" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Precio" class="form-label"></label>
                    <input asp-for="Precio" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="Precio" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Stock" class="form-label"></label>
                    <input asp-for="Stock" class="form-control" type="number" min="0" />
                    <span asp-validation-for="Stock" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="CodigoBarras" class="form-label">Código de barras</label>
                    <div class="input-group">
                        <input asp-for="CodigoBarras" class="form-control" placeholder="Escanea o escribe el código" />
                        <button type="button" class="btn btn-outline-primary" id="btnIniciarEscaneo">
                            <i class="bi bi-upc-scan"></i> Escanear
                        </button>
                    </div>
                    <span asp-validation-for="CodigoBarras" class="text-danger"></span>
                </div>

                <div id="contenedorEscaner" class="mb-3 d-none">
                    <div class="border rounded position-relative overflow-hidden">
                        <div id="visorEscaner" class="scanner-viewport"></div>
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" id="btnDetenerEscaneo">
                            <i class="bi bi-stop-circle"></i> Detener
                        </button>
                    </div>
                    <small class="text-muted d-block mt-2">Escanea un nuevo código si necesitas actualizarlo.</small>
                </div>

                <div class="mb-3">
                    <label asp-for="IdProveedor" class="form-label">Proveedor</label>
                    <select asp-for="IdProveedor" class="form-select" asp-items="ViewBag.IdProveedor"></select>
                    <span asp-validation-for="IdProveedor" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="IdCategoria" class="form-label">Categoría</label>
                    <select asp-for="IdCategoria" class="form-select" asp-items="ViewBag.IdCategoria"></select>
                    <span asp-validation-for="IdCategoria" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="FechaCreacion" class="form-label"></label>
                    <input asp-for="FechaCreacion" class="form-control" type="date" />
                    <span asp-validation-for="FechaCreacion" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="FechaVencimiento" class="form-label"></label>
                    <input asp-for="FechaVencimiento" class="form-control" type="date" />
                    <span asp-validation-for="FechaVencimiento" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label class="form-label" for="fotoProducto">Fotografía del producto</label>
                    <input type="file" class="form-control" id="fotoProducto" name="nuevaFoto" accept="image/*" />
                    <small class="text-muted">Selecciona una nueva imagen para actualizarla.</small>
                </div>

                <div class="mb-4">
                    <div class="text-center">
                        <img id="previewProducto" src="@fotoActual" alt="Vista previa del producto" class="img-thumbnail @clasePreview" style="max-height: 220px;" />
                        <div id="placeholderProducto" class="text-muted @clasePlaceholder">Aún no se ha cargado una imagen para este producto.</div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-arrow-left-circle"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js" integrity="sha512-kpbbgCulvRlQCk2BEm90LkAMPx/+qvOB0fOkH1ZZ1xd6Q671O5jM90+hCbGyF/F7fs/3Gzdh0dX8GZFODdgNpA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        (function () {
            const codigoInput = document.getElementById('CodigoBarras');
            const iniciarBtn = document.getElementById('btnIniciarEscaneo');
            const detenerBtn = document.getElementById('btnDetenerEscaneo');
            const contenedorEscaner = document.getElementById('contenedorEscaner');
            const visorEscaner = document.getElementById('visorEscaner');
            let escanerActivo = false;

            const iniciarEscaner = () => {
                if (escanerActivo) {
                    return;
                }

                contenedorEscaner.classList.remove('d-none');

                Quagga.init({
                    inputStream: {
                        type: 'LiveStream',
                        target: visorEscaner,
                        constraints: {
                            facingMode: 'environment'
                        }
                    },
                    decoder: {
                        readers: ['ean_reader', 'ean_8_reader', 'code_128_reader', 'code_39_reader', 'upc_reader', 'upc_e_reader']
                    }
                }, function (err) {
                    if (err) {
                        console.error(err);
                        contenedorEscaner.classList.add('d-none');
                        alert('No fue posible acceder a la cámara. Verifica los permisos del navegador.');
                        return;
                    }
                    Quagga.start();
                    escanerActivo = true;
                });
            };

            const detenerEscaner = () => {
                if (escanerActivo) {
                    Quagga.stop();
                    escanerActivo = false;
                }
                contenedorEscaner.classList.add('d-none');
            };

            if (iniciarBtn && detenerBtn) {
                iniciarBtn.addEventListener('click', iniciarEscaner);
                detenerBtn.addEventListener('click', detenerEscaner);
            }

            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    detenerEscaner();
                }
            });

            Quagga.onDetected(function (result) {
                if (!result || !result.codeResult || !result.codeResult.code) {
                    return;
                }
                codigoInput.value = result.codeResult.code;
                detenerEscaner();
                codigoInput.focus();
            });

            const inputFoto = document.getElementById('fotoProducto');
            const preview = document.getElementById('previewProducto');
            const placeholder = document.getElementById('placeholderProducto');

            if (inputFoto) {
                inputFoto.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            preview.src = e.target.result;
                            preview.classList.remove('d-none');
                            placeholder.classList.add('d-none');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        preview.src = '@fotoActual';
                        if (preview.src) {
                            preview.classList.remove('d-none');
                            placeholder.classList.add('d-none');
                        } else {
                            preview.classList.add('d-none');
                            placeholder.classList.remove('d-none');
                        }
                    }
                });
            }
        })();
    </script>
}
